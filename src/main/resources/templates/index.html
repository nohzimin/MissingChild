<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장기실종아동찾기</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/mainstyle.css">
    <link rel="stylesheet" href="/assets/css/header.css">
</head>
<body>

<!-- Header -->
<header class="top-header">
    <div class="header-container">
        <!-- 로고와 왼쪽 네비게이션 -->
        <div class="nav-group">
            <a href="/" class="logo">
                <img src="/assets/img/logo.png" alt="장기 실종 아동 찾기" class="logo-image">
            </a>

            <!-- 주요기능 드롭다운 -->
            <div class="nav-dropdown">
                <button class="dropdown-toggle">
                    주요기능
                    <i class="fas fa-chevron-down nav-icon"></i>
                </button>
                <div class="dropdown-menu">
                    <a href="/missing-child/list">실종 아동 보기</a>
                    <a href="/missing-child/register">실종 아동 등록</a>
                </div>
            </div>

            <!-- 검색 버튼 -->
            <a href="/missing-child/search" class="nav-link">
                <i class="fas fa-search nav-icon"></i>
                실종아동 검색
            </a>

            <!-- 게시판 버튼 -->
            <a href="/board/list" class="nav-link">
                <i class="fas fa-list nav-icon"></i>
                게시판
            </a>
        </div>

        <!-- 오른쪽 네비게이션 -->
        <ul class="nav-right">

            <li class="nav-item" th:if="${user == null}">
                <a class="nav-link" href="/login">
                    <i class="fas fa-sign-in-alt nav-icon"></i> 로그인
                </a>
            </li>
            <li class="nav-item" th:if="${user == null}">
                <a class="nav-link dark" href="/signup">
                    <i class="fas fa-user-plus nav-icon"></i> 회원가입
                </a>
            </li>
            <li class="nav-item" th:if="${user != null}">
                <a class="nav-link">
                    <i class="fas fa-user nav-icon"></i>
                    <span th:text="${user.name + '님'}">이름</span>
                </a>
            </li>
            <li class="nav-item" th:if="${user != null}">
                <a class="nav-link" href="/mypage">
                    <i class="fas fa-home nav-icon"></i> MYPAGE
                </a>
            </li>
            <li class="nav-item" th:if="${user != null}">
                <a class="nav-link dark" href="/logout">
                    <i class="fas fa-sign-out-alt nav-icon"></i> 로그아웃
                </a>
            </li>
        </ul>
    </div>
</header>

<!-- Hero Section -->
<section class="hero">
    <div class="hero-content">
        <h1>안면 인식으로 실종 아동을 찾습니다</h1>
        <p>인공지능 기반의 얼굴 인식 기술로 실종된 아이들을 빠르고 정확하게 찾아줍니다.</p>
    </div>
</section>

<!-- Features Section -->
<section class="features">
    <div class="container">
        <h2>서비스 특징</h2>
        <div class="row mt-5">
            <div class="col-md-4">
                <div class="feature-item">
                    <div class="card">
                        <div class="card-front">
                            <img src="/assets/img/index/facescaner.gif" alt="AI 얼굴 인식">
                        </div>
                        <div class="card-back">
                            <h2>AI 얼굴 인식</h2>
                            <p>안면 인식 알고리즘으로 실종 아동의 <br> 얼굴을 정확하게 식별합니다</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="feature-item">
                    <div class="card">
                        <div class="card-front">
                            <img src="/assets/img/index/realtime.gif" alt="실시간 업데이트">
                        </div>
                        <div class="card-back">
                            <h2>실시간 업데이트</h2>
                            <p>실종 아동 데이터는 즉시 업데이트되어 <br> 최신 상태를 유지합니다</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="feature-item">
                    <div class="card">
                        <div class="card-front">
                            <img src="/assets/img/index/korea.gif" alt="전국 네트워크">
                        </div>
                        <div class="card-back">
                            <h2>전국 네트워크</h2>
                            <p>관련 기관과 협력하여 전국적인 <br> 검색 네트워크를 제공합니다</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- 그래프 섹션 -->
<section class="stats-section">
    <div class="container">
        <h2 class="section-title">장기 실종 아동 통계</h2>
        <div class="charts-wrapper">
            <div class="chart-container">
                <canvas id="missingChildStatusChart"></canvas>
                <p>20년 이상 장기 실종 아동 현황</p>
            </div>
            <div class="chart-container">
                <canvas id="missingChildFoundStatusChart"></canvas>
                <p>19-23년 실종 아동 등 미발견 현황</p>
            </div>
        </div>
    </div>
</section>

<!-- 실종아동보기 -->
<section class="find-child-section">
    <div class="find-child-content">
        <h2 class="section-title">실종 아동들을 위한 작은 관심이 <br> 큰 변화를 만듭니다</h2>
        <a href="/missing-child/list" class="btn btn-primary">실종 아동 보기</a>
    </div>
</section>

<!-- 최근 등록된 실종아동 -->
<section class="recent-cases">
    <div class="container">
        <h2>최근 등록된 실종 아동</h2>
        <div class="carousel-container">
            <div id="caseCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner" id="searchResults">
                    <!-- 여기에 동적으로 카드들이 추가됩니다 -->
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#caseCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#caseCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>
    </div>
</section>

<!-- 아동 상세 정보 모달 -->
<div id="childDetailModal" class="modal fade" tabindex="-1" aria-labelledby="childDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="childDetailLabel">아동 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="childDetailContent">
                <!-- 아동 상세 정보가 여기에 동적으로 추가됩니다 -->
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer>
    <p>&copy; 노나리조</p>
    <a href="#" class="scroll-top">🔝</a>
</footer>

<!-- 사용자 이메일을 서버에서 받아와 세션 스토리지에 저장 -->
<th:block th:if="${user != null}">
    <script>
        const userId = /*[[${'#'}]]*/'[[${user.userId}]]';
        sessionStorage.setItem('userId', userId);
        console.log('Stored userId:', userId);
    </script>
</th:block>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/assets/js/chartAnimations.js"></script>
<script src="/assets/js/header.js"></script>

<script>
    window.onload = async function () {
        recentList();
    }


    const getImgSrc = (photoUrl) => {
        if (!photoUrl) {
            return "/assets/img/child/default-image.jpg";
        } else if (photoUrl.startsWith("http://") || photoUrl.startsWith("https://")) {
            return photoUrl;
        } else {
            return `/assets/img/child/${photoUrl}`;
        }
    };

    async function recentList() {
        let url = "/api/missing-child/recentList";
        let response = await fetch(url);
        let data = await response.json();
        if (data.result == "success") {
            let missingChildDtoList = data.missingChildDtoList;
            let searchResults = document.querySelector('#searchResults');
            searchResults.innerHTML = ''; // 기존 내용 초기화

            // 4개씩 그룹화
            for (let i = 0; i < missingChildDtoList.length; i += 4) {
                let groupCards = missingChildDtoList.slice(i, i + 4);
                let carouselItem = document.createElement('div');
                carouselItem.className = 'carousel-item' + (i === 0 ? ' active' : '');

                let cardsWrapper = document.createElement('div');
                cardsWrapper.className = 'cards-wrapper';

                groupCards.forEach(child => {
                    // imgSrc 결정
                    const imgSrc = getImgSrc(child.photoUrl);
                    let card = document.createElement('div');
                    card.className = 'case-card';
                    card.innerHTML = `
                    <img src="${imgSrc}" alt="${child.childName}">
                    <div class="case-info">
                        <h3>${child.childName}</h3>
                        <p>현재나이: <span>${child.childAge}</span>세</p>
                        <p>실종일자: <br> <span>${child.missingSince}</span></p>
                    </div>
                `;

                    // 클릭 이벤트 추가
                    card.addEventListener('click', () => showChildDetail(child.childId));

                    cardsWrapper.appendChild(card);
                });

                carouselItem.appendChild(cardsWrapper);
                searchResults.appendChild(carouselItem);
            }
        } else {
            alert("상세조회 과정에서 오류가 발생했습니다.");
        }
    }

    // 아동 상세 정보 모달 표시 함수
    async function showChildDetail(childId) {
        try {
            const url = `/api/missing-child/list/${childId}`;
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error("아동 상세 정보를 불러오는 데 실패했습니다.");
            }

            const child = await response.json();

            const genderText = child.childGender === "M" ? "남자" : "여자";
            // imgSrc 결정
            const imgSrc = getImgSrc(child.photoUrl);

            const detailHtml = `
            <img src="${imgSrc}" class="img-fluid mb-3" alt="${child.childName}">
            <h5>이름: ${child.childName}</h5>
            <p>나이: ${child.childAge}세</p>
            <p>생일: ${child.dateOfBirth}</p>
            <p>성별: ${genderText}</p>
            <p>실종 장소: ${child.lastKnownLocation}</p>
            <p>실종 일자: ${child.missingSince}</p>
        `;
            document.getElementById("childDetailContent").innerHTML = detailHtml;

            const modal = new bootstrap.Modal(document.getElementById("childDetailModal"));
            modal.show();
        } catch (error) {
            console.error("Error:", error);
            alert("오류가 발생했습니다. 다시 시도해주세요.");
        }
    }

    // 스크롤 탑 버튼
    document.querySelector('.scroll-top').addEventListener('click', function(event) {
        event.preventDefault();
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // 스크롤 탑 버튼 표시/숨김 처리
    window.addEventListener('scroll', function() {
        const scrollTop = document.querySelector('.scroll-top');
        if (window.scrollY > 500) {
            scrollTop.classList.add('visible');
        } else {
            scrollTop.classList.remove('visible');
        }
    });

    // 차트 애니메이션 효과
    document.addEventListener('DOMContentLoaded', function() {
        const options = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                }
            }
        };

        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate');
                    observer.unobserve(entry.target);
                }
            });
        }, options);

        document.querySelectorAll('.chart-container').forEach(chart => {
            observer.observe(chart);
        });
    });

    // 피처 카드 애니메이션
    document.querySelectorAll('.feature-item').forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.querySelector('.card').style.transform = 'rotateY(180deg)';
        });

        item.addEventListener('mouseleave', function() {
            this.querySelector('.card').style.transform = 'rotateY(0deg)';
        });
    });
</script>
</body>
</html>